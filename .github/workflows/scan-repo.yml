name: Vulnerability Scan

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'Repository URL to scan'
        required: true
        type: string
      scanners:
        description: 'Scanners to use (comma-separated, leave empty for auto-detect)'
        required: false
        type: string
      parallel_mode:
        description: 'Run scanners in parallel (faster but uses more runners)'
        required: false
        type: boolean
        default: false

jobs:
  scan:
    runs-on: ubuntu-latest
    if: ${{ !inputs.parallel_mode }}
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout scan repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv sync

      - name: Install scanners
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          # Install OSV Scanner
          curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o /usr/local/bin/osv-scanner
          chmod +x /usr/local/bin/osv-scanner

          # Install Semgrep
          pip install semgrep

      - name: Parse scanners input
        id: parse-scanners
        run: |
          if [ -n "${{ inputs.scanners }}" ]; then
            # Convert comma-separated to space-separated for CLI
            SCANNERS=$(echo "${{ inputs.scanners }}" | tr ',' ' ')
            echo "scanners_arg=--scanners $SCANNERS" >> $GITHUB_OUTPUT
          else
            echo "scanners_arg=" >> $GITHUB_OUTPUT
          fi

      - name: Run vulnerability scan
        run: |
          uv run python -m vmcp.cli scan "${{ inputs.repo_url }}" --output-dir results ${{ steps.parse-scanners.outputs.scanners_arg }}

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: results/

      - name: Aggregate results
        run: |
          uv run python -m vmcp.cli aggregate --results-dir results

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PR_CREATE_PAT }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/create_scan_pr.sh
          ./scripts/create_scan_pr.sh "${{ inputs.repo_url }}"

  parallel-scan:
    runs-on: ubuntu-latest
    if: ${{ inputs.parallel_mode }}
    strategy:
      matrix:
        scanner: [trivy, osv-scanner, semgrep]
    permissions:
      contents: write

    steps:
      - name: Checkout scan repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv sync

      - name: Install scanner
        run: |
          if [ "${{ matrix.scanner }}" = "trivy" ]; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          elif [ "${{ matrix.scanner }}" = "osv-scanner" ]; then
            curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o /usr/local/bin/osv-scanner
            chmod +x /usr/local/bin/osv-scanner
          elif [ "${{ matrix.scanner }}" = "semgrep" ]; then
            pip install semgrep
          fi

      - name: Run scanner
        run: |
          uv run python -m vmcp.cli scan "${{ inputs.repo_url }}" --output-dir results --scanners ${{ matrix.scanner }}

      - name: Upload scan results artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ matrix.scanner }}
          path: results/
          retention-days: 1

  aggregate-parallel-results:
    runs-on: ubuntu-latest
    needs: parallel-scan
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout scan repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv sync

      - name: Download all scanner results
        uses: actions/download-artifact@v4
        with:
          pattern: scan-results-*
          merge-multiple: true
          path: results/

      - name: Aggregate results
        run: |
          uv run python -m vmcp.cli aggregate --results-dir results

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PR_CREATE_PAT }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/create_scan_pr.sh
          ./scripts/create_scan_pr.sh "${{ inputs.repo_url }}"
