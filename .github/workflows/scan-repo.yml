name: Vulnerability Scan

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'Repository URL to scan'
        required: true
        type: string
      scanners:
        description: 'Scanners to use (comma-separated, leave empty for all)'
        required: false
        type: string
        default: ''
      command:
        description: 'Scan command: scan or scan-tool'
        required: false
        type: string
        default: 'scan'

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      scanner-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Prepare scanner matrix
        id: set-matrix
        run: |
          SCANNERS="${{ inputs.scanners }}"
          
          # Default to all scanners if input is empty
          if [ -z "$SCANNERS" ]; then
            SCANNERS="trivy,osv-scanner,semgrep,yara"
          fi
          
          # Convert comma-separated to JSON array
          MATRIX=$(echo "$SCANNERS" | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$"; ""))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Using scanners: $MATRIX"

  parallel-scan:
    runs-on: ubuntu-latest
    needs: prepare-matrix
    strategy:
      matrix:
        scanner: ${{ fromJson(needs.prepare-matrix.outputs.scanner-matrix) }}
      fail-fast: false
    permissions:
      contents: write

    steps:
      - name: Checkout scan repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Install scanner
        run: |
          if [ "${{ matrix.scanner }}" = "trivy" ]; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          elif [ "${{ matrix.scanner }}" = "osv-scanner" ]; then
            curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o /usr/local/bin/osv-scanner
            chmod +x /usr/local/bin/osv-scanner
          elif [ "${{ matrix.scanner }}" = "semgrep" ]; then
            pip install semgrep
          elif [ "${{ matrix.scanner }}" = "yara" ]; then
            sudo apt-get update && sudo apt-get install -y libyara-dev
            pip install yara-python
          fi

      - name: Run scanner
        run: |
          if [ "${{ inputs.command }}" = "scan-tool" ]; then
            OUTPUT_DIR="results_tools"
          else
            OUTPUT_DIR="results"
          fi
          uv run python -m vmcp.cli ${{ inputs.command }} "${{ inputs.repo_url }}" --output-dir "$OUTPUT_DIR" --scanners ${{ matrix.scanner }}

      - name: Upload scan results artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ matrix.scanner }}
          path: |
            results/
            results_tools/
          retention-days: 1

  aggregate-parallel-results:
    runs-on: ubuntu-latest
    needs: parallel-scan
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout scan repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Download all scanner results
        uses: actions/download-artifact@v4
        with:
          pattern: scan-results-*
          merge-multiple: true
          path: ./

      - name: Aggregate results
        run: |
          if [ "${{ inputs.command }}" = "scan-tool" ]; then
            uv run python -m vmcp.cli aggregate-tool "${{ inputs.repo_url }}" --results-dir results_tools
          else
            uv run python -m vmcp.cli aggregate "${{ inputs.repo_url }}" --results-dir results
          fi

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PR_CREATE_PAT }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/create_scan_pr.sh
          ./scripts/create_scan_pr.sh "${{ inputs.repo_url }}"